name: "Update gir and all gir-files"

permissions:
  contents: write
on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: "true"
      - uses: ./.github/actions/install_deps
      - uses: dtolnay/rust-toolchain@master
        with:
            toolchain: nightly
            components: rustfmt, clippy
      ## Update the submodules
      - name: Update submodules
        run: |
          git submodule update --remote
      ## Update the gir submodule and install the new version
      - name: Install gir
        working-directory: ./gir
        run: |
          ls
          export PATH=$PATH:/github/home/.cargo/bin
          cargo install --force --path .
      - uses: ./.github/actions/build_regenerate_test
      - name: Commit updated code + submodules
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Detect changes, ignoring gir/, gir-files/, and versions.txt
          if git diff --quiet HEAD -- . \
            ':(exclude)gir' \
            ':(exclude)gir-files' \
            ':(exclude)*/src/auto/versions.txt'; then
            echo "No relevant changes to commit."
            exit 0
          fi

          # Something else changed â†’ commit everything
          git add -A
          git commit -m "Automatically updated generated code and submodules"
          git push




